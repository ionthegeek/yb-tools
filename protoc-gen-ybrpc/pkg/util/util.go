package util

import (
	"google.golang.org/protobuf/compiler/protogen"
	"google.golang.org/protobuf/reflect/protoreflect"
	"google.golang.org/protobuf/types/descriptorpb"
)

func GenerateHeader(g *protogen.GeneratedFile, file *protogen.File) {
	protoDeclaration := GetProtoDeclaration(file)
	GenerateComments(g, GenerateCommentSet(protoDeclaration), false)

	g.P("// Code generated by protoc-gen-ybrpc. DO NOT EDIT.")

	packageDeclaration := GetPackageDeclaration(file)
	GenerateComments(g, GenerateCommentSet(packageDeclaration), file.Desc.Options().(*descriptorpb.FileOptions).GetDeprecated())

	g.P()
	g.P("package ", file.GoPackageName)
	g.P()
}

func GenerateComments(g *protogen.GeneratedFile, comments protogen.CommentSet, deprecated bool) {
	for _, s := range comments.LeadingDetached {
		g.P(s)
		g.P()
	}
	if s := comments.Leading; s != "" {
		g.P(s)
	}
	if deprecated {
		g.P(protogen.Comments(" Deprecated: Do not use."))
	}
}

func GenerateCommentSet(location protoreflect.SourceLocation) protogen.CommentSet {
	commentSet := protogen.CommentSet{}
	for _, comment := range location.LeadingDetachedComments {
		commentSet.LeadingDetached = append(commentSet.LeadingDetached, protogen.Comments(comment))
	}

	commentSet.Leading = protogen.Comments(location.LeadingComments)

	return commentSet
}

func GetProtoDeclaration(f *protogen.File) protoreflect.SourceLocation {
	return f.Desc.SourceLocations().ByPath(protoreflect.SourcePath{12})
}

func GetPackageDeclaration(f *protogen.File) protoreflect.SourceLocation {
	return f.Desc.SourceLocations().ByPath(protoreflect.SourcePath{2})
}
